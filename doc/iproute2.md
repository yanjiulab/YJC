# IP

## 策略路由（IP rule）

IP rule 是策略路由（Routing policy database， RPDB）管理工具。

每条策略路由规则包括一个选择器（selector）和一个动作指示（action），数据包到来时，根据优先级降序（数字越小，优先级越高）依次搜索策略路由规则，如果 selector 匹配成功，则执行相应的动作。如果动作执行了，则返回路由或者失败，同时结束查找。否则，继续搜索下一条规则。

在系统启动时，内核配置了默认的 RPDB，包括三个规则：

优先级|选择器|动作|说明
:---:|:---:|:---:|:---:
0|匹配所有|查找 local (0) 路由表|特殊路由表，用于匹配广播和本地路由，该规则不可删除。
32766|匹配所有|查找 main (254) 路由表|用于匹配系统主路由表，该规则可以由管理员修改或删除。
32767|匹配所有|查找 default (253) 路由表|用于没有匹配策略之后的 post-processing，表默认为空，该规则可以删除。

### 规则类型

策略路由规则有 5 种类型：

- unicast：返回单播路由表项。
- blackhole：丢弃数据包。
- unreachable：生成“网络不可达”错误。
- prohibit：生成“通信被系统保护”错误。
- nat：修改数据包源地址。

### 规则匹配器

策略路由规则匹配器包括：

- from：根据源地址匹配。
- to：根据目的地址匹配。
- iif：如果是 lo，则可以为本地数据包和转发数据包制定不同的数据包。
- oif：只应用于本地绑定了设备的套接字发出的数据包。
- tos/dsfield：根据 tos 字段匹配。
- fwmark：根据 firewall mark 匹配。iptables 可以用来标记，从而用于策略路由。
- ipproto：根据 IP 协议匹配。
- sport：根据源端口匹配，支持范围匹配。
- dport：根据目的端口匹配，支持范围匹配。

### 规则动作

规则动作包括：

- table/lookup：查询路由表。
- protocol：指示添加该规则的路由协议，例如 zebra。
- nat：转换的地址。
- realms：TODO。
- goto：转到指定规则。
