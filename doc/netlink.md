# Netlink

## TODO

- route
- genl
- nf

## 寻址

Netlink 协议是基于套接字的进程间通信（IPC）机制，它可用于用户空间进程和内核之间或者用户空间进程之间的通信。Netlink协议基于BSD套接字并使用AF_NETLINK地址簇。每一个Netlink协议都有自己的协议号（比如：NETLINK_ROUTE、NETLINK_NETFILTER等）。它的寻址方案是基于 32 位的端口号（之前被称为 PID），此端口号用于唯一地标识每一个对等通信节点。

Netlink 地址（端口）由一个 32 位的整数组成。端口（port）零保留给内核使用，表示每个Netlink协议簇中内核部分的套接字，其他的端口则通常指的是用户空间的套接字。

注意： 最初通常使用进程标识符（PID）作为本地端口号，但这种方式随着线程化Netlink应用程序的引入而失效，因为这类进程需要多个套接字。为解决此项冲突，libnl以进程标识符为基数再加上一个偏移量来生成唯一的端口号，此方式可以让一个进程使用多个套接字。出于向后兼容方面的考虑，第一个套接字还是以进程标识符作为端口号。

## 场景

Netlink 的常见应用场景：

- 用户空间的进程和内核的通信： Netlink 最常见的应用场景就是用户空间应用程序发送请求给内核，比如设置/读取接口的IP地址，然后接受并处理内核返回的信息，这个回复信息要么是请求出错的信息，要么就是请求成功的通知信息。
- 用户空间内进程之间的通信： Netlink也可以直接作为用户空间应用程序之间的进程间通信机制，但这种方式并不常见，通常会代之以unix域套接字。这种通信并不限制在两个对等通信节点之间，任意一个节点都可以和其他的对等点进行通信。此外因为Netlink支持多播，一条消息可以由多个节点同时接收到。
- 侦听内核的多播通知：此类Netlink通信是一种非常常见的应用方式，此方式可以让用户空间那些需要处理特定内核事件的的守护进程侦听内核反馈的消息/事件。这些应用程序进程通常会订阅内核使用的某个多播组，内核则在某些事件发生的时候通过它来通知订阅该组播组的进程。

## 消息

### 消息格式

Netlink协议通常是基于消息的，消息则通常是由 Netlink 消息头部（struct nlmsghdr）加上有效载荷组成。虽然有效载荷可以由任何数据组成，但是它通常的格式是一 个固定大小的协议相关头部后面紧跟一系列的属性。

- 总长度（32 位）：消息包括 netlink 消息头部在内的总字节数
- 消息类型（16 位）：消息类型指明了消息的有效载荷的类型。netlink 协议定义了多个标准的消息类型。每个协 议簇都可能定义了额外的消息类型。
- 消息标志（16 位）：消息标志可以用来更改消息类型的行为。
- 序列号（32 位）：序列号的使用是可选的，它可以用来引用前一条消息。比如一条错误消息中可以引用导致错 误的那条请求消息。
- 端口号：端口号指明了这条消息需要发往哪个对等节点。如果没有指定端口号，那么这条消息会被投 递给同一个协议簇中第一个匹配的内核端套接字。

### 消息类型

Netlink 在请求消息（requests）、通知消息（notifications）和应答消息（replies）的 处理上是有区别的。请求消息设有 NLM_F_REQUEST 标志位，它用来向接收方请求某种响应 。一般来说请求消息都是从用户空间发送到内核的。虽然不是强制规定，但每次发送的请求 消息序列号都应该是上一个序列号加一。

由于请求自身的特性，接收方在收到请求消息之后可能会发送另一条 netlink 消息来响应 这个请求。应答消息的序列号必须和它响应的那条请求消息的序列号一致。

通知消息则没有那么严谨，它不需要应答，所以序列号通常是被设置成 0 的。

消息的类型主要是由消息头部中 16 位的消息类型字段确定的。Netlink 定义了如下标准消息类型：

- NLMSG_NOOP - 无需任何操作，消息必须被丢弃
- NLMSG_ERROR - 错误消息或者是 ACK，
- NLMSG_DONE - 分段序列的结束
- NLMSG_OVERRUN - 通知消息越界错误

### 消息标志

NLM_F_REQUEST - 请求消息
NLM_F_MULTI - 分片消息
NLM_F_ACK - 请求了 ACK 回复
NLM_F_ECHO - 请求回应这个请求消息。

NLM_F_ROOT - 返回树的根节点。
NLM_F_MATCH - 返回所有匹配的节点。
NLM_F_ATOMIC - 已废弃，以前用来请求一个原子操作
NLM_F_DUMP - 返回一个含有所有对象的列表（NLM_F_ROOT|NLM_F_MATCH）

NLM_F_REPLACE - 如果对象存在的话，替换它。
NLM_F_EXCL - 如果这个对象存在的话，就不用更新它。
NLM_F_CREATE - 如果对象不存在的话，创建它。
NLM_F_APPEND - 在对象列表的末尾添加新的对象。

### 序列号

Netlink允许通过序列号来关联回复和请求。需要注意的是，这里的序列号和 TCP 这类的协议的序列号是不一样的，Netlink的序列号并不强制使用。序列号唯一的用途就是把一条应答消息和相应的请求消息联系起来，序列号是以单个套接字为基础来管理。

这段代码定义了一个枚举类型 rtattr_type_t，其中包含了 Netlink Route 子系统中所支持的属性类型。具体说明如下：

- RTA_UNSPEC：未指定类型
- RTA_DST：目标网络地址
- RTA_SRC：源网络地址
- RTA_IIF：路由表项输入网络接口索引
- RTA_OIF：路由表项输出网络接口索引
- RTA_GATEWAY：网关地址
- RTA_PRIORITY：路由表项优先级
- RTA_PREFSRC：首选源地址
- RTA_METRICS：度量值
- RTA_MULTIPATH：多路径
- RTA_PROTOINFO：协议信息（已不再使用）
- RTA_FLOW：流量控制
- RTA_CACHEINFO：缓存信息
- RTA_SESSION：会话信息（已不再使用）
- RTA_MP_ALGO：多路径算法（已不再使用）
- RTA_TABLE：路由表编号
- RTA_MARK：标记
- RTA_MFC_STATS：多播转发统计信息
- RTA_VIA：途经中间节点
- RTA_NEWDST：新的目标网络地址
- RTA_PREF：首选路由项
- RTA_ENCAP_TYPE：封装类型
- RTA_ENCAP：封装数据
- RTA_EXPIRES：过期时间
- RTA_PAD：填充
- RTA_UID：用户ID
- RTA_TTL_PROPAGATE：TTL传播
- RTA_IP_PROTO：IP协议
- RTA_SPORT：源端口
- RTA_DPORT：目标端口
- __RTA_MAX：最大值
